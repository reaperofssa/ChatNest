<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Fixed viewport to expand to full screen when toolbar is hidden -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Telegram Chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: #ffffff;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      height: 100vh;
      height: 100dvh;
      position: relative;
    }

    /* Background animation */
    #app::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(147, 51, 234, 0.05) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translateX(0) translateY(0); }
      33% { transform: translateX(-20px) translateY(-10px); }
      66% { transform: translateX(10px) translateY(-20px); }
    }

    #header {
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 10;
      /* Made header clickable */
      cursor: pointer;
    }

    #header:hover {
      background: rgba(15, 15, 35, 0.98);
    }

    /* Added back button styling */
    .back-button {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      margin-right: 12px;
    }

    .back-button:hover {
      background: rgba(139, 92, 246, 0.4);
      transform: scale(1.05);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      pointer-events: none;
    }

    .profile-pic {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      border: 2px solid rgba(139, 92, 246, 0.3);
    }

    .profile-pic img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-info p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin: 2px 0 0 0;
    }

    .verified-badge {
      width: 16px;
      height: 16px;
      /* Using /verified.png instead of text badge */
      background-image: url('/verified.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .menu-button {
      background: none;
      border: none;
      color: #8b5cf6;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .menu-button:hover {
      background: rgba(139, 92, 246, 0.1);
      transform: scale(1.05);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
      font-size: 15px;
      animation: messageSlide 0.3s ease-out;
      /* Added cursor pointer for reply functionality */
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.15);
    }

    /* Added sender name styling */
    .sender-name {
      font-size: 12px;
      font-weight: 600;
      color: rgba(139, 92, 246, 0.8);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sender-name.verified::after {
      content: '';
      width: 14px;
      height: 14px;
      background-image: url('/verified.png');
      background-size: contain;
      background-repeat: no-repeat;
    }

    .message.sent {
      align-self: flex-end;
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      border-bottom-right-radius: 6px;
      /* Better borders for sent messages */
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    .message.received {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom-left-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Special borders for verified users */
    .message.verified {
      border: 2px solid rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
    }

    .message.verified::before {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      background: linear-gradient(45deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.3));
      border-radius: inherit;
      z-index: -1;
    }

    /* Reply styling with thumbnails */
    .reply-preview {
      background: rgba(0, 0, 0, 0.2);
      border-left: 3px solid #8b5cf6;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reply-thumbnail {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .reply-content {
      flex: 1;
      overflow: hidden;
    }

    .reply-author {
      font-weight: 600;
      color: #8b5cf6;
      margin-bottom: 2px;
    }

    .reply-text {
      color: rgba(255, 255, 255, 0.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .message-content {
      margin-bottom: 4px;
    }

    /* Better media display */
    .message-media {
      max-width: 100%;
      border-radius: 12px;
      margin: 8px 0;
      display: block;
    }

    .message-media img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .message-media img:hover {
      transform: scale(1.02);
    }

    .message-media video,
    .message-media audio {
      max-width: 100%;
      border-radius: 12px;
      outline: none;
    }

    .message-media video {
      max-height: 300px;
    }

    .sticker {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .sticker:hover {
      transform: scale(1.1);
    }

    .message-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      text-align: right;
      margin-top: 4px;
    }

    .message.sent .message-time {
      color: rgba(255, 255, 255, 0.7);
    }

    #typing-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: #8b5cf6;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    #input-container {
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(139, 92, 246, 0.2);
      padding: 16px 20px;
      /* Compact and organized input container */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #media-preview-container {
      display: none;
      position: relative;
    }

    #media-preview {
      max-width: 120px;
      max-height: 120px;
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    #media-preview-container button {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }

    #message-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 20px;
      padding: 12px 16px;
      color: white;
      font-size: 15px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      outline: none;
      transition: all 0.2s ease;
      /* Prevent iOS zoom on input focus */
      font-size: 16px;
    }

    #message-input:focus {
      border-color: #8b5cf6;
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    #message-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .input-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-button {
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      color: #8b5cf6;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .input-button:hover {
      background: rgba(139, 92, 246, 0.3);
      transform: scale(1.05);
    }

    .input-button:active {
      transform: scale(0.95);
    }

    #send-button {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      border: none;
    }

    #send-button:hover {
      background: linear-gradient(135deg, #7c3aed, #9333ea);
    }

    #send-button:disabled {
      background: rgba(139, 92, 246, 0.3);
      cursor: not-allowed;
      transform: none;
    }

    .char-counter {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      text-align: right;
      margin-top: 4px;
    }

    .char-counter.warning {
      color: #fbbf24;
    }

    .char-counter.error {
      color: #ef4444;
    }

    #stickers-container {
      display: none;
      background: rgba(15, 15, 35, 0.95);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .stickers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
    }

    .sticker-item {
      position: relative;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .sticker-item:hover {
      transform: scale(1.05);
    }

    .sticker-item img {
      width: 100%;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    .sticker-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(239, 68, 68, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .sticker-item:hover .sticker-delete {
      opacity: 1;
    }

    #stickers-toggle.active {
      background: rgba(139, 92, 246, 0.4);
    }

    #create-sticker-button {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s ease;
    }

    #create-sticker-button:hover {
      background: rgba(34, 197, 94, 0.3);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 50%;
      border-top-color: #8b5cf6;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #no-messages {
      display: none;
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      margin-top: 40px;
    }

    .custom-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      padding: 24px;
      z-index: 1000;
      min-width: 300px;
      text-align: center;
    }

    .custom-alert h3 {
      color: #8b5cf6;
      margin-bottom: 12px;
      font-size: 18px;
    }

    .custom-alert p {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .custom-alert button {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Added reply indicator styling */
    .reply-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(139, 92, 246, 0.9);
      color: white;
      padding: 12px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .reply-indicator.show {
      display: flex;
    }

    .reply-cancel {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }

    @media (max-width: 768px) {
      #header {
        padding: 16px;
      }
      
      #messages {
        padding: 16px;
      }
      
      #input-container {
        padding: 12px 16px;
      }
      
      .message {
        max-width: 85%;
        font-size: 14px;
      }

      .profile-pic {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }

      .user-info h2 {
        font-size: 16px;
      }
    }

    /* Prevent easy zooming on iOS */
    @media screen and (max-width: 768px) {
      input, textarea, select {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Made header clickable to navigate to info page -->
    <div id="header" onclick="navigateToInfo()">
      <!-- Added back button -->
      <button class="back-button" onclick="event.stopPropagation(); window.location.href='/chats.html'">
        ←
      </button>
      <div class="header-left">
        <div class="profile-pic" id="profile-pic">
          <img id="profile-image" src="/placeholder.svg" alt="" style="display: none;">
          <span id="profile-initial">?</span>
        </div>
        <div class="user-info">
          <h2 id="user-name">
            Loading...
            <span class="verified-badge" id="verified-badge" style="display: none;"></span>
          </h2>
          <p id="user-status">Loading...</p>
        </div>
      </div>
      <div class="header-right">
        <button class="menu-button" onclick="event.stopPropagation(); navigateToInfo();">⋯</button>
      </div>
    </div>

    <!-- Added reply indicator -->
    <div id="reply-indicator" class="reply-indicator">
      <div>
        <strong>Replying to:</strong>
        <span id="reply-preview-text"></span>
      </div>
      <button class="reply-cancel" onclick="cancelReply()">×</button>
    </div>

    <div id="messages">
      <div id="no-messages">No messages yet. Start the conversation!</div>
    </div>

    <div id="typing-indicator">
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <span id="typing-text">Someone is typing...</span>
    </div>

    <div id="input-container">
      <div id="media-preview-container">
        <img id="media-preview" alt="Preview">
        <button onclick="clearMediaPreview()">×</button>
        <button id="create-sticker-button" style="display: none;">Make Sticker 🎨</button>
      </div>

      <div id="stickers-container">
        <div class="stickers-grid" id="stickers-grid">
          <!-- Stickers will be loaded here -->
        </div>
      </div>

      <div class="input-row">
        <textarea 
          id="message-input" 
          placeholder="Type a message..." 
          rows="1"
          oninput="autoResize(); updateCharCounter(); handleTyping();"
        ></textarea>
        
        <div class="input-buttons">
          <button class="input-button" id="file-button" title="Attach file">📎</button>
          <button class="input-button" id="stickers-toggle" title="My Stickers 🎨">😊</button>
          <button class="input-button" id="send-button" title="Send message">➤</button>
        </div>
      </div>
      
      <div class="char-counter" id="char-counter">0/1000</div>
    </div>

    <input type="file" id="file-input" style="display: none;" accept="image/*,video/*,audio/*">
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io();
    let isLoading = false;
    let earliestTimestamp = null;
    let replyingTo = null;
    let typingTimeout = null;
    let recipientData = null;
    let isSticker = false;
    const MAX_CHARS = 1000;
    const MAX_STICKERS = 20;

    const params = window.location.pathname.split("/");
    const recipientId = params[params.length - 1];
    const authToken = localStorage.getItem("authToken");

    console.log("authToken:", authToken);
    console.log("recipientId:", recipientId);

    function navigateToInfo() {
      window.location.href = `/info/${recipientId}`;
    }

    function replyToMessage(messageId, messageText, senderName, fileUrl, fileType) {
      replyingTo = messageId;
      const replyIndicator = document.getElementById('reply-indicator');
      const replyPreviewText = document.getElementById('reply-preview-text');
      
      let previewText = '';
      if (fileUrl && fileType?.startsWith('image')) {
        previewText = `${senderName}: 📷 Image`;
      } else if (fileUrl && fileType?.startsWith('video')) {
        previewText = `${senderName}: 🎥 Video`;
      } else if (fileUrl && fileType?.startsWith('audio')) {
        previewText = `${senderName}: 🎵 Audio`;
      } else {
        previewText = `${senderName}: ${messageText?.slice(0, 50) || 'Message'}`;
      }
      
      replyPreviewText.textContent = previewText;
      replyIndicator.classList.add('show');
      
      // Focus message input
      document.getElementById('message-input').focus();
    }

    function cancelReply() {
      replyingTo = null;
      document.getElementById('reply-indicator').classList.remove('show');
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (!authToken) {
        showCustomAlert("Authentication Required", "Please log in to continue.");
        window.location.href = "/login";
        return;
      }
      
      loadRecipientData();
      loadStickers();
      setupEventListeners();
      loadMessages();
      updateCharCounter();
      setupSocketListeners();
      
      // Join user room for real-time messaging
      socket.emit("joinUserRoom", authToken);
    });

    async function loadRecipientData() {
      try {
        const res = await fetch(`/user/id/${recipientId}`);
        const data = await res.json();
        
        if (res.ok) {
          recipientData = data;
          document.getElementById("user-name").innerHTML = `
            ${data.name || data.username}
            ${data.verified ? '<span class="verified-badge"></span>' : ''}
          `;
          
          if (data.profileimg && data.profileimg !== "https://example.com/default-profile.png") {
            document.getElementById("profile-image").src = data.profileimg;
            document.getElementById("profile-image").style.display = "block";
            document.getElementById("profile-initial").style.display = "none";
          } else {
            document.getElementById("profile-initial").textContent = (data.name || data.username).charAt(0).toUpperCase();
          }
          
          updateOnlineStatus();
        } else {
          console.error("Error loading recipient data:", data.error);
          showCustomAlert("Error", "Failed to load user information");
        }
      } catch (err) {
        console.error("Error loading recipient data:", err);
        showCustomAlert("Error", "Failed to load user information");
      }
    }

    function updateOnlineStatus() {
      const lastSeen = localStorage.getItem(`lastSeen_${recipientId}`);
      const statusElement = document.getElementById("user-status");
      
      if (lastSeen) {
        const lastSeenDate = new Date(lastSeen);
        const now = new Date();
        const diffMinutes = Math.floor((now - lastSeenDate) / (1000 * 60));
        
        if (diffMinutes < 5) {
          statusElement.textContent = "Online";
          statusElement.style.color = "#22c55e";
        } else if (diffMinutes < 60) {
          statusElement.textContent = `Last seen ${diffMinutes}m ago`;
          statusElement.style.color = "rgba(255, 255, 255, 0.7)";
        } else if (diffMinutes < 1440) {
          const hours = Math.floor(diffMinutes / 60);
          statusElement.textContent = `Last seen ${hours}h ago`;
          statusElement.style.color = "rgba(255, 255, 255, 0.7)";
        } else {
          const days = Math.floor(diffMinutes / 1440);
          statusElement.textContent = `Last seen ${days}d ago`;
          statusElement.style.color = "rgba(255, 255, 255, 0.5)";
        }
      } else {
        statusElement.textContent = "Offline";
        statusElement.style.color = "rgba(255, 255, 255, 0.5)";
      }
    }

    async function loadMessages(before = null) {
      if (isLoading) return;
      isLoading = true;

      if (before) {
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = '<div class="loading-spinner"></div> Loading older messages...';
        loadingDiv.id = 'loading-messages';
        loadingDiv.style.textAlign = 'center';
        loadingDiv.style.padding = '12px';
        loadingDiv.style.color = 'rgba(255, 255, 255, 0.6)';
        document.getElementById('messages').insertBefore(loadingDiv, document.getElementById('messages').firstChild);
      }

      try {
        const url = before 
          ? `/messages/${recipientId}?authToken=${encodeURIComponent(authToken)}&limit=20&before=${encodeURIComponent(before)}`
          : `/messages/${recipientId}?authToken=${encodeURIComponent(authToken)}&limit=20`;
        
        console.log("Fetching messages from:", url);
        const res = await fetch(url);
        const data = await res.json();

        if (res.ok) {
          console.log("Messages received:", data);
          const noMessagesDiv = document.getElementById("no-messages");
          if (data.length === 0 && !before) {
            noMessagesDiv.style.display = "block";
          } else {
            noMessagesDiv.style.display = "none";
            renderMessages(data.reverse(), !before);
            if (data.length > 0) {
              earliestTimestamp = data[0].timestamp;
            }
          }
        } else {
          console.error("Error fetching messages:", data.error);
          showCustomAlert("Error", data.error || "Failed to load messages");
        }
      } catch (err) {
        console.error("Error fetching messages:", err);
        showCustomAlert("Error", "Error loading messages");
      } finally {
        isLoading = false;
        const loadingDiv = document.getElementById('loading-messages');
        if (loadingDiv) loadingDiv.remove();
      }
    }

    function setupSocketListeners() {
      socket.on("newMessage", (msg) => {
        console.log("[v0] Received new message via WebSocket:", msg);
        
        // Add to messages array
        messages.push(msg);
        
        // Render immediately without reload
        renderMessage(msg);
        
        // Update typing indicator
        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator.style.display === "flex") {
          typingIndicator.style.display = "none";
        }
      });

      socket.on("showTyping", ({ users }) => {
        const typingIndicator = document.getElementById("typing-indicator");
        const typingText = document.getElementById("typing-text");
        
        if (users.length > 0) {
          const names = users.map(u => (u.name || u.username) + (u.verified ? ' ✓' : '')).join(", ");
          typingText.textContent = `${names} ${users.length > 1 ? "are" : "is"} typing...`;
          typingIndicator.style.display = "flex";
        } else {
          typingIndicator.style.display = "none";
        }
      });

      socket.on("hideTyping", () => {
        document.getElementById("typing-indicator").style.display = "none";
      });
    }

    function renderMessages(messages, scrollToBottom = false) {
      const messagesContainer = document.getElementById("messages");
      const currentScrollTop = messagesContainer.scrollTop;
      const currentScrollHeight = messagesContainer.scrollHeight;

      messages.forEach(msg => {
        // Check if message already exists
        if (document.querySelector(`[data-message-id="${msg.id}"]`)) {
          return;
        }

        const messageDiv = document.createElement("div");
        const isSent = msg.senderId != recipientId;
        const sender = isSent ? { id: msg.senderId, name: "You", verified: false } : recipientData;
        
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}${sender?.verified ? ' verified' : ''}`;
        messageDiv.setAttribute('data-message-id', msg.id);
        
        let content = '';
        
        if (msg.replyTo) {
          const replyMsg = messages.find(m => m.id === msg.replyTo) || { text: 'Original message', senderId: recipientId };
          const replyAuthor = replyMsg.senderId == recipientId ? (recipientData?.name || 'User') : 'You';
          
          content += `<div class="reply-preview">`;
          
          if (replyMsg.fileUrl && replyMsg.fileType?.startsWith('image')) {
            content += `<img src="${replyMsg.fileUrl}" class="reply-thumbnail" alt="Reply image">`;
          }
          
          content += `<div class="reply-content">
            <div class="reply-author">${replyAuthor}</div>
            <div class="reply-text">${replyMsg.text || 'Media message'}</div>
          </div></div>`;
        }
        
        if (msg.text) {
          content += `<div class="message-content">${msg.text}</div>`;
        }
        
        if (msg.fileUrl) {
          content += `<div class="message-media">`;
          
          if (msg.fileType?.startsWith('image')) {
            if (msg.issticker) {
              content += `<img src="${msg.fileUrl}" class="sticker" alt="Sticker">`;
            } else {
              content += `<img src="${msg.fileUrl}" alt="Image" onclick="window.open('${msg.fileUrl}', '_blank')">`;
            }
          } else if (msg.fileType?.startsWith('video')) {
            content += `<video controls>
              <source src="${msg.fileUrl}" type="${msg.fileType}">
              Your browser does not support the video tag.
            </video>`;
          } else if (msg.fileType?.startsWith('audio')) {
            content += `<audio controls>
              <source src="${msg.fileUrl}" type="${msg.fileType}">
              Your browser does not support the audio tag.
            </audio>`;
          } else {
            content += `<a href="${msg.fileUrl}" target="_blank" style="color: #8b5cf6; text-decoration: underline;">📎 Download File</a>`;
          }
          
          content += `</div>`;
        }
        
        const timestamp = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        content += `<div class="message-time">${timestamp}</div>`;
        
        messageDiv.innerHTML = content;
        messagesContainer.appendChild(messageDiv);
        
        // Render replies
        if (msg.replies && msg.replies.length > 0) {
          msg.replies.forEach(reply => {
            renderMessages([reply], false);
          });
        }
      });

      if (scrollToBottom) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } else {
        messagesContainer.scrollTop = currentScrollTop + (messagesContainer.scrollHeight - currentScrollHeight);
      }
    }

    function setupEventListeners() {
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const fileInput = document.getElementById("file-input");
      const fileButton = document.getElementById("file-button");
      const mediaPreview = document.getElementById("media-preview");
      const mediaPreviewContainer = document.getElementById("media-preview-container");
      const createStickerButton = document.getElementById("create-sticker-button");
      const stickersContainer = document.getElementById("stickers-container");
      const stickersToggle = document.getElementById("stickers-toggle");

      fileButton.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            if (file.type.startsWith('image')) {
              mediaPreview.src = reader.result;
              mediaPreviewContainer.style.display = "flex";
              createStickerButton.style.display = "inline-block";
            } else {
              // For non-image files, show file name
              mediaPreview.style.display = "none";
              mediaPreviewContainer.innerHTML = `
                <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; margin-bottom: 8px;">
                  📎 ${file.name}
                  <button onclick="clearMediaPreview()" style="float: right; background: none; border: none; color: #8b5cf6; cursor: pointer;">×</button>
                </div>
              `;
              mediaPreviewContainer.style.display = "block";
              createStickerButton.style.display = "none";
            }
            isSticker = false;
          };
          reader.readAsDataURL(file);
        } else {
          clearMediaPreview();
        }
      });

      createStickerButton.addEventListener("click", () => {
        isSticker = true;
        createStickerButton.style.display = "none";
        createStickerButton.textContent = "✓ Sticker Mode";
        createStickerButton.style.display = "inline-block";
      });

      stickersToggle.addEventListener("click", () => {
        const isVisible = stickersContainer.style.display === "block";
        stickersContainer.style.display = isVisible ? "none" : "block";
        stickersToggle.classList.toggle("active", !isVisible);
      });

      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            sendMessage();
          }
          // Allow normal Enter for line breaks
        }
      });

      sendButton.addEventListener("click", sendMessage);

      document.getElementById("messages").addEventListener("scroll", (e) => {
        if (e.target.scrollTop === 0 && earliestTimestamp && !isLoading) {
          loadMessages(earliestTimestamp);
        }
      });
    }

    function handleTyping() {
      socket.emit("typing", { room: `user_${recipientId}`, authToken });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit("stopTyping", { room: `user_${recipientId}`, authToken });
      }, 3000);
    }

    function updateCharCounter() {
      const messageInput = document.getElementById("message-input");
      const charCounter = document.getElementById("char-counter");
      const sendButton = document.getElementById("send-button");
      const length = messageInput.value.length;
      
      charCounter.textContent = `${length}/1000`;
      charCounter.className = 'char-counter';
      
      if (length > 800) {
        charCounter.classList.add('warning');
      }
      if (length > 1000) {
        charCounter.classList.add('error');
        sendButton.disabled = true;
      } else {
        sendButton.disabled = false;
      }
    }

    function autoResize() {
      const messageInput = document.getElementById("message-input");
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }

    function loadStickers() {
      const stickers = JSON.parse(localStorage.getItem("stickers") || "[]");
      const container = document.getElementById("stickers-grid");
      container.innerHTML = "";
      
      stickers.forEach((sticker, index) => {
        const stickerDiv = document.createElement("div");
        stickerDiv.className = "sticker-item";
        stickerDiv.innerHTML = `
          <img src="${sticker}" alt="Sticker" onclick="sendSticker('${sticker}')">
          <button class="sticker-delete" onclick="deleteSticker(${index})">×</button>
        `;
        container.appendChild(stickerDiv);
      });
    }

    function deleteSticker(index) {
      const stickers = JSON.parse(localStorage.getItem("stickers") || "[]");
      stickers.splice(index, 1);
      localStorage.setItem("stickers", JSON.stringify(stickers));
      loadStickers();
    }

    async function sendSticker(stickerUrl) {
      try {
        const res = await fetch(stickerUrl);
        const blob = await res.blob();
        const reader = new FileReader();
        
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          await sendMessage(null, base64, blob.type, true);
        };
        
        reader.readAsDataURL(blob);
      } catch (err) {
        console.error("Error sending sticker:", err);
        showCustomAlert("Error", "Failed to send sticker");
      }
      
      document.getElementById("stickers-container").style.display = "none";
      document.getElementById("stickers-toggle").classList.remove("active");
    }

    async function sendMessage(text = null, fileBase64 = null, fileType = null, isStickerParam = false) {
      const messageInput = document.getElementById("message-input");
      const fileInput = document.getElementById("file-input");
      
      const messageText = text || messageInput.value.trim();
      let base64Data = fileBase64;
      let mediaType = fileType;
      let stickerMode = isStickerParam || isSticker;
      
      if (!base64Data && fileInput.files[0]) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          await sendMessage(messageText, base64, file.type, stickerMode);
        };
        
        reader.readAsDataURL(file);
        return;
      }
      
      if (!messageText && !base64Data) {
        return;
      }
      
      try {
        const payload = {
          authToken,
          text: messageText,
          replyTo: replyingTo
        };
        
        if (base64Data) {
          payload.fileBase64 = base64Data;
          payload.fileType = mediaType;
          payload.issticker = stickerMode;
          
          // Save sticker to localStorage
          if (stickerMode) {
            const stickers = JSON.parse(localStorage.getItem("stickers") || "[]");
            if (stickers.length >= MAX_STICKERS) {
              showCustomAlert("Sticker Limit", `You can only have ${MAX_STICKERS} stickers. Delete some to add new ones.`);
              return;
            }
          }
        }
        
        console.log("Sending message:", payload);
        const res = await fetch(`/message/${recipientId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (res.ok) {
          console.log("Message sent successfully:", data);
          
          // Save sticker after successful send
          if (base64Data && stickerMode) {
            const stickers = JSON.parse(localStorage.getItem("stickers") || "[]");
            const stickerUrl = data.data.fileUrl;
            if (stickerUrl && !stickers.includes(stickerUrl)) {
              stickers.push(stickerUrl);
              localStorage.setItem("stickers", JSON.stringify(stickers));
              loadStickers();
            }
          }
          
          // Clear inputs
          messageInput.value = "";
          clearMediaPreview();
          replyingTo = null;
          isSticker = false;
          updateCharCounter();
          autoResize();
          
          // Update last message time for online status
          localStorage.setItem(`lastSeen_${data.data.senderId}`, new Date().toISOString());
          
        } else {
          console.error("Error sending message:", data.error);
          showCustomAlert("Error", data.error || "Failed to send message");
        }
      } catch (err) {
        console.error("Error sending message:", err);
        showCustomAlert("Error", "Failed to send message");
      }
    }

    function clearMediaPreview() {
      const mediaPreviewContainer = document.getElementById("media-preview-container");
      const fileInput = document.getElementById("file-input");
      const createStickerButton = document.getElementById("create-sticker-button");
      
      mediaPreviewContainer.style.display = "none";
      mediaPreviewContainer.innerHTML = `
        <img id="media-preview" alt="Preview">
        <button onclick="clearMediaPreview()">×</button>
        <button id="create-sticker-button" style="display: none;">Make Sticker 🎨</button>
      `;
      fileInput.value = "";
      isSticker = false;
      
      // Re-attach event listener
      document.getElementById("create-sticker-button").addEventListener("click", () => {
        isSticker = true;
        document.getElementById("create-sticker-button").style.display = "none";
      });
    }

    function showCustomAlert(title, message) {
      const alertDiv = document.createElement("div");
      alertDiv.className = "custom-alert";
      alertDiv.innerHTML = `
        <h3>${title}</h3>
        <p>${message}</p>
        <button onclick="this.parentElement.remove()">OK</button>
      `;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // Update online status every minute
    setInterval(updateOnlineStatus, 60000);
  </script>
</body>
</html>
