<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
  body { margin:0; font-family:sans-serif; background:#f5f5f5; display:flex; flex-direction:column; height:100vh; }
  #topBar { display:flex; align-items:center; padding:10px; background:#0084ff; color:white; }
  #backBtn { margin-right:10px; cursor:pointer; font-weight:bold; }
  #chatContainer { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column-reverse; }
  .message { background:white; padding:8px 12px; border-radius:10px; margin:5px 0; max-width:70%; word-wrap:break-word; position:relative; }
  .message.sent { align-self:flex-end; background:#dcf8c6; }
  .message.received { align-self:flex-start; }
  .message img { max-width:200px; border-radius:10px; margin-top:5px; display:block; }
  .message .sticker { width:120px; height:120px; }
  .message .reply { font-size:0.8em; color:#555; border-left:2px solid #ccc; padding-left:4px; margin-bottom:3px; cursor:pointer; }
  #inputContainer { display:flex; padding:10px; background:white; align-items:center; flex-wrap:wrap; }
  #messageInput { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; resize:none; overflow:hidden; }
  #sendBtn, #fileBtn { margin-left:10px; padding:10px 15px; border:none; border-radius:20px; background:#0084ff; color:white; cursor:pointer; }
  #typing { font-size:0.8em; color:#888; margin:5px 10px; }
  #previewContainer { display:flex; margin:5px 10px; }
  #previewContainer img { max-width:100px; max-height:100px; margin-right:5px; border-radius:10px; cursor:pointer; border:2px solid #0084ff; }
</style>
</head>
<body>

<div id="topBar">
  <div id="backBtn">&larr; Back</div>
  <div id="chatTitle">Chat</div>
</div>

<div id="chatContainer"></div>
<div id="typing"></div>
<div id="previewContainer"></div>

<div id="inputContainer">
  <textarea id="messageInput" rows="1" placeholder="Type a message..."></textarea>
  <input type="file" id="fileInput" style="display:none;">
  <button id="fileBtn">ðŸ“Ž</button>
  <button id="sendBtn">Send</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('fileInput');
const typingIndicator = document.getElementById('typing');
const backBtn = document.getElementById('backBtn');
const previewContainer = document.getElementById('previewContainer');

backBtn.addEventListener('click', () => window.location.href = '/chats.html');

const recipientId = window.location.pathname.split("/chat/")[1];

let limit = 10, offset = 0, loading = false, allLoaded = false, replyToId = null;
let selectedFile = null;

// Auto resize textarea
function resizeTextarea() {
  messageInput.style.height = 'auto';
  messageInput.style.height = messageInput.scrollHeight + 'px';
}
messageInput.addEventListener('input', resizeTextarea);

// Infinite scroll
chatContainer.addEventListener('scroll', async () => {
  if (chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 10) {
    await loadMessages();
  }
});

// Load messages
async function loadMessages() {
  if (loading || allLoaded) return;
  loading = true;
  try {
    const res = await fetch(`/messages/${recipientId}?limit=${limit}&from=${offset}`);
    const messages = await res.json();
    if (messages.length < limit) allLoaded = true;
    offset += messages.length;
    messages.reverse().forEach(msg => chatContainer.appendChild(createMessageElement(msg)));
  } catch(e) { console.error(e); }
  loading = false;
}

// Create message element
function createMessageElement(msg) {
  const div = document.createElement('div');
  div.classList.add('message', msg.senderId === Number(localStorage.userId) ? 'sent' : 'received');
  div.dataset.id = msg.id;

  if (msg.replyTo && msg.replyToText) {
    const replyDiv = document.createElement('div');
    replyDiv.classList.add('reply');
    replyDiv.textContent = msg.replyToText.slice(0,50);
    replyDiv.onclick = () => { replyToId = msg.replyTo; messageInput.focus(); }
    div.appendChild(replyDiv);
  }

  if (msg.text) {
    const p = document.createElement('p');
    p.innerHTML = msg.text.replace(/\n/g,'<br>');
    div.appendChild(p);
  }

  if (msg.fileType?.startsWith('image/') && !msg.issticker) {
    const img = document.createElement('img');
    img.src = msg.fileUrl;
    div.appendChild(img);
  }

  if (msg.issticker) {
    const sticker = document.createElement('img');
    sticker.src = msg.fileUrl;
    sticker.classList.add('sticker');
    div.appendChild(sticker);
  }

  return div;
}

// Typing
messageInput.addEventListener('input', () => {
  socket.emit('typing', { to: recipientId });
});

// Send message
sendBtn.addEventListener('click', sendMessage);

// Enter adds line break
messageInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    messageInput.value += '\n';
    resizeTextarea();
  }
});

// File picker
fileBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (!file) return;
  selectedFile = file;
  previewContainer.innerHTML = '';
  const reader = new FileReader();
  reader.onload = () => {
    const img = document.createElement('img');
    img.src = reader.result;
    img.onclick = () => { previewContainer.innerHTML=''; selectedFile=null; }
    previewContainer.appendChild(img);
  };
  reader.readAsDataURL(file);
});

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text && !selectedFile && !replyToId) return;

  let payload = { authToken: localStorage.authToken, text, replyTo: replyToId };

  if (selectedFile) {
    const reader = new FileReader();
    reader.onload = async () => {
      payload.fileBase64 = reader.result.split(',')[1];
      payload.fileType = selectedFile.type;
      payload.issticker = selectedFile.type.startsWith('image/');
      try {
        const res = await fetch(`/message/${recipientId}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data = await res.json();
        chatContainer.prepend(createMessageElement(data.data));
        messageInput.value=''; selectedFile=null; replyToId=null; previewContainer.innerHTML='';
        resizeTextarea();
      } catch(e){ console.error(e); }
    };
    reader.readAsDataURL(selectedFile);
  } else {
    try {
      const res = await fetch(`/message/${recipientId}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const data = await res.json();
      chatContainer.prepend(createMessageElement(data.data));
      messageInput.value=''; replyToId=null; resizeTextarea();
    } catch(e){ console.error(e); }
  }
}

// Socket listeners
socket.on('newMessage', (msg) => {
  if (Number(msg.senderId)===Number(recipientId) || Number(msg.receiverId)===Number(recipientId)) {
    chatContainer.prepend(createMessageElement(msg));
  }
});

socket.on('typing', (data) => {
  if (Number(data.from)===Number(recipientId)) {
    typingIndicator.textContent = 'Typing...';
    clearTimeout(typingIndicator.timeout);
    typingIndicator.timeout = setTimeout(()=>typingIndicator.textContent='',1000);
  }
});

// Initial load
loadMessages();
resizeTextarea();
</script>
</body>
</html>
